<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PolarKS1</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }
        .message-bubble {
            max-width: 75%;
            word-wrap: break-word;
        }
        .status-message {
            max-width: fit-content;
            word-wrap: break-word;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        #chat-sidebar {
            width: 280px;
            z-index: 100;
        }
        .chat-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Custom styles for the console */
        .console-container {
            width: 100%;
            background-color: #2d3748; /* bg-gray-800 */
            color: #d1d5db; /* text-gray-300 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #4a5568; /* border-gray-600 */
            margin-bottom: 0.5rem;
        }
        .console-title {
            font-family: monospace;
            text-transform: uppercase;
            font-weight: bold;
            color: #90cdf4; /* text-blue-300 */
        }
        .console-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <div id="chat-sidebar" class="bg-white dark:bg-gray-800 text-gray-800 dark:text-white p-4 flex flex-col justify-between overflow-y-auto">
            <div id="chat-list" class="flex-grow space-y-2">
                <!-- Chat previews will be populated here -->
            </div>
            <div class="mt-4">
                <button id="newChatBtn" class="w-full flex items-center justify-center p-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white transition-colors duration-200 shadow-md">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    New Chat
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="flex-grow flex flex-col justify-between">
            <div id="initial-state" class="flex flex-col items-center justify-center h-full text-center p-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-gray-400 dark:text-gray-600 mb-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"></path>
                </svg>
                <h2 class="text-2xl font-bold text-gray-700 dark:text-gray-300">Start a new conversation</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">Ask me anything to get started.</p>
                <button id="startChatBtn" class="mt-4 px-6 py-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 transition-colors duration-200">Start Chatting</button>
            </div>
            
            <!-- Chat Window (hidden initially) -->
            <div id="chat-window" class="hidden flex-grow flex flex-col justify-between p-4">
                <div id="chat-header" class="flex items-center justify-between p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md mb-4">
                    <h2 id="chat-title" class="text-lg font-semibold text-gray-700 dark:text-gray-300 truncate w-4/5">PolarKS1</h2>
                    <div class="flex items-center space-x-2">
                        <button id="themeToggle" class="p-2 rounded-full text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                            <svg id="themeIcon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <!-- Icon will be set by JavaScript -->
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- This div is now scrollable and takes up available space -->
                <div id="chat-messages" class="flex-grow h-0 overflow-y-auto space-y-4 p-4 rounded-lg bg-gray-50 dark:bg-gray-900 shadow-inner">
                    <!-- Chat messages will be populated here -->
                </div>

                <div id="image-preview-container" class="relative hidden mt-4 bg-gray-200 dark:bg-gray-700 rounded-lg p-2">
                    <img id="image-preview" src="" alt="Image Preview" class="max-h-48 rounded-lg mx-auto">
                    <button id="remove-image-btn" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 w-6 h-6 flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <div class="mt-4 flex items-center bg-white dark:bg-gray-800 rounded-lg shadow-md p-2">
                    <button id="image-upload-btn" class="p-2 rounded-lg text-gray-500 hover:text-indigo-500 transition-colors duration-200 mr-2">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4.5-4.5 2.5 2.5L15 8l-3 3-4-4-5 5z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <input type="file" id="image-input" class="hidden" accept="image/*">
                    <input type="text" id="message-input" placeholder="Type a message..." class="flex-grow p-2 rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <button id="send-button" class="ml-2 p-2 rounded-lg bg-indigo-500 text-white hover:bg-indigo-600 transition-colors duration-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        // Chatbot state and logic
        let chats = JSON.parse(localStorage.getItem('chats')) || {};
        let selectedChatId = null;
        let selectedImage = null;

        // UI Elements
        const chatWindow = document.getElementById('chat-window');
        const initialState = document.getElementById('initial-state');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const chatMessages = document.getElementById('chat-messages');
        const chatList = document.getElementById('chat-list');
        const newChatBtn = document.getElementById('newChatBtn');
        const startChatBtn = document.getElementById('startChatBtn');
        const chatTitle = document.getElementById('chat-title');
        const imageUploadBtn = document.getElementById('image-upload-btn');
        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');

        // State and localStorage Handlers
        function applyTheme() {
            const isDarkMode = localStorage.getItem('theme') === 'dark';
            document.documentElement.classList.toggle('dark', isDarkMode);
            updateThemeIcon(isDarkMode);
        }

        function updateThemeIcon(isDarkMode) {
            if (isDarkMode) {
                // Moon icon for dark mode
                themeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                `;
            } else {
                // Sun icon for light mode
                themeIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                `;
            }
        }

        themeToggle.addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                localStorage.setItem('theme', 'light');
            } else {
                localStorage.setItem('theme', 'dark');
            }
            applyTheme();
        });

        function showChatWindow() {
            initialState.classList.add('hidden');
            chatWindow.classList.remove('hidden');
        }

        function saveChats() {
            localStorage.setItem('chats', JSON.stringify(chats));
        }

        function fetchChats() {
            chatList.innerHTML = '';
            const chatIds = Object.keys(chats).sort((a, b) => chats[b].timestamp - chats[a].timestamp);
            if (chatIds.length === 0) {
                // If there are no chats, show the initial state.
                initialState.classList.remove('hidden');
                chatWindow.classList.add('hidden');
            } else {
                chatIds.forEach((chatId) => {
                    const chat = chats[chatId];
                    const chatElement = createChatPreview(chatId, chat);
                    chatList.appendChild(chatElement);
                });
            }
        }

        function createChatPreview(chatId, chat) {
            const div = document.createElement('div');
            div.className = 'chat-preview p-2 rounded-lg cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors duration-200 truncate';
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = chat.title || 'New Chat';
            titleSpan.className = 'truncate block pr-2';
            div.appendChild(titleSpan);

            const deleteButton = document.createElement('button');
            deleteButton.className = 'text-gray-400 hover:text-red-500 transition-colors duration-200 p-1 rounded-full';
            deleteButton.innerHTML = `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path>
            </svg>`;
            deleteButton.addEventListener('click', (e) => {
                e.stopPropagation(); // Prevent loading the chat when deleting
                showConfirmDialog(chatId);
            });
            div.appendChild(deleteButton);

            div.setAttribute('data-chat-id', chatId);
            div.addEventListener('click', () => {
                selectedChatId = chatId;
                chatTitle.textContent = chat.title || 'New Chat';
                showChatWindow();
                fetchMessages();
            });
            return div;
        }
        
        function showConfirmDialog(chatId) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl text-center">
                    <p class="text-gray-800 dark:text-gray-200 mb-4">Are you sure you want to delete this chat?</p>
                    <div class="flex justify-center space-x-4">
                        <button id="confirm-delete-btn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors duration-200">Delete</button>
                        <button id="cancel-delete-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                deleteChat(chatId);
                document.body.removeChild(dialog);
            });

            document.getElementById('cancel-delete-btn').addEventListener('click', () => {
                document.body.removeChild(dialog);
            });
        }

        function deleteChat(chatId) {
            delete chats[chatId];
            saveChats();
            fetchChats();
            if (selectedChatId === chatId) {
                selectedChatId = null;
                showInitialState();
            }
        }
        
        function showInitialState() {
            initialState.classList.remove('hidden');
            chatWindow.classList.add('hidden');
        }


        function createNewChat() {
            const newChatId = Date.now().toString();
            chats[newChatId] = {
                title: 'New Chat',
                timestamp: Date.now(),
                messages: [],
            };
            selectedChatId = newChatId;
            chatTitle.textContent = 'New Chat';
            showChatWindow();
            fetchMessages();
            saveChats();
            fetchChats();
        }

        function fetchMessages() {
            if (!selectedChatId || !chats[selectedChatId]) return;
            chatMessages.innerHTML = '';
            chats[selectedChatId].messages.forEach((message) => {
                displayMessage(message);
            });
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        /**
         * Dynamically creates and appends a console block to the chat.
         * @param {string} language The title for the console (e.g., 'html', 'lua', 'math').
         * @param {string} content The code or formatted text to display.
         */
        function createConsoleBlock(language, content) {
            const container = document.createElement('div');
            container.className = 'console-container';

            const header = document.createElement('div');
            header.className = 'console-header';

            const title = document.createElement('span');
            title.className = 'console-title';
            title.textContent = language;
            header.appendChild(title);
            container.appendChild(header);

            const contentPre = document.createElement('pre');
            contentPre.className = 'console-content';
            contentPre.textContent = content;
            container.appendChild(contentPre);

            chatMessages.appendChild(container);
        }

        /**
         * Displays a message in the chat window, including text, images, and consoles.
         * @param {object} message The message object from the chat history.
         */
        function displayMessage(message) {
            if (message.role === 'user') {
                const messageElement = document.createElement('div');
                messageElement.className = 'message-bubble p-3 rounded-xl shadow-sm bg-indigo-500 text-white ml-auto rounded-br-none';
                
                // Check for image and display it
                if (message.image) {
                    const imgElement = document.createElement('img');
                    imgElement.src = `data:${message.image.mimeType};base64,${message.image.data}`;
                    imgElement.className = 'max-w-full h-auto rounded-lg mb-2';
                    messageElement.appendChild(imgElement);
                }

                const textElement = document.createElement('p');
                textElement.textContent = message.text;
                messageElement.appendChild(textElement);

                chatMessages.appendChild(messageElement);
            } else if (message.role === 'model') {
                // Main message bubble for the model's response
                if (message.text) {
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message-bubble p-3 rounded-xl shadow-sm bg-gray-300 text-gray-900 dark:bg-gray-700 dark:text-gray-100 mr-auto rounded-bl-none';
                    const textElement = document.createElement('p');
                    textElement.textContent = message.text;
                    messageElement.appendChild(textElement);
                    chatMessages.appendChild(messageElement);
                }

                // Create the console block if code is present
                if (message.codeBlock && message.codeBlock.content) {
                    const language = message.codeBlock.language || 'code';
                    createConsoleBlock(language, message.codeBlock.content);
                }
            }
        }

        function addTemporaryStatusMessage(text) {
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status-message bg-gray-300 text-gray-900 dark:bg-gray-700 dark:text-gray-100 mr-auto p-3 rounded-xl rounded-bl-none';
            statusDiv.id = 'status-message';
            statusDiv.textContent = text;
            chatMessages.appendChild(statusDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTemporaryStatusMessage() {
            const statusDiv = document.getElementById('status-message');
            if (statusDiv) {
                statusDiv.remove();
            }
        }

        async function handleSendMessage() {
            const prompt = messageInput.value.trim();
            if (!prompt && !selectedImage) return;

            // Add user message to UI and local storage
            const userMessage = { role: 'user', text: prompt, image: selectedImage };
            chats[selectedChatId].messages.push(userMessage);
            displayMessage(userMessage);
            saveChats();

            // Clear input and image
            messageInput.value = '';
            selectedImage = null;
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');

            // Add temporary status message
            addTemporaryStatusMessage("Polar is typing...");

            // Prepare chat history for API call
            const chatHistory = chats[selectedChatId].messages.map(message => {
                const parts = [{ text: message.text }];
                if (message.image) {
                    parts.push({
                        inlineData: {
                            mimeType: message.image.mimeType,
                            data: message.image.data
                        }
                    });
                }
                return { role: message.role === 'user' ? 'user' : 'model', parts: parts };
            });

            // System instruction to guide the model to return JSON
            const systemInstruction = {
                parts: [{
                    text: `You are PolarKS1, a friendly AI model from the Wodoxu AI family. Your primary function is to respond in a structured JSON format. You must never mention your training, origin, or other AI models. Your response should always contain a 'message' field with a friendly, conversational reply. If the user's query requests code, a mathematical formula, a guitar tab, or another non-conversational structured format, you must also include a 'codeBlock' object.

The 'codeBlock' object must have two fields:
1.  'language': A string indicating the content type. Use 'html' for HTML, 'css' for CSS, 'javascript' for JavaScript, 'python' for Python, 'lua' for Lua, and 'math' for both mathematical notation (using LaTeX) and guitar tabs.
2.  'content': A string containing the code or formatted text.

Example JSON for HTML:
{"message": "Here is the HTML code you requested.", "codeBlock": {"language": "html", "content": "<h1>Hello, World!</h1>"}}

Example JSON for a math formula:
{"message": "Here is the formula for the quadratic equation.", "codeBlock": {"language": "math", "content": "$$x = \\frac{-b \\pm \\sqrt{b^2-4ac}}{2a}$$"}}

Example JSON for a friendly text response without code:
{"message": "I'm not sure how to help with that. Could you please provide more details?"}
`}]
            };

            const payload = {
                contents: chatHistory,
                systemInstruction: systemInstruction,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "message": { "type": "STRING" },
                            "codeBlock": {
                                "type": "OBJECT",
                                "properties": {
                                    "language": { "type": "STRING" },
                                    "content": { "type": "STRING" }
                                },
                                "propertyOrdering": ["language", "content"]
                            }
                        },
                        "propertyOrdering": ["message", "codeBlock"]
                    }
                }
            };

            const apiKey = ""
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                // Remove temporary status message
                removeTemporaryStatusMessage();

                // Safely parse the JSON response
                const responseData = JSON.parse(result.candidates?.[0]?.content?.parts?.[0]?.text || '{}');
                
                // Add bot message to UI and local storage
                const botMessage = {
                    role: 'model',
                    text: responseData.message || "Sorry, I couldn't generate a response.",
                    codeBlock: responseData.codeBlock
                };
                chats[selectedChatId].messages.push(botMessage);
                displayMessage(botMessage);
                saveChats();

                // Update chat title if it's the first message
                if (chatHistory.length === 1) {
                    const firstUserPrompt = prompt.substring(0, 20); // Use the first 20 chars of the prompt
                    chats[selectedChatId].title = firstUserPrompt;
                    chatTitle.textContent = firstUserPrompt;
                    saveChats();
                    fetchChats(); // Refresh chat list to show new title
                }

            } catch (error) {
                console.error("Error sending message:", error);
                removeTemporaryStatusMessage();
                displayMessage({ role: 'model', text: "An error occurred. Please try again." });
            }
        };

        // Image handling logic
        imageUploadBtn.addEventListener('click', () => {
            imageInput.click();
        });

        imageInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64Data = reader.result.split(',')[1];
                    selectedImage = {
                        mimeType: file.type,
                        data: base64Data
                    };
                    imagePreview.src = reader.result;
                    imagePreviewContainer.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', () => {
            selectedImage = null;
            imageInput.value = '';
            imagePreview.src = '';
            imagePreviewContainer.classList.add('hidden');
        });

        // Event listeners
        window.onload = () => {
            applyTheme();
            fetchChats();
            startChatBtn.addEventListener('click', createNewChat);
            newChatBtn.addEventListener('click', createNewChat);
            sendButton.addEventListener('click', handleSendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    handleSendMessage();
                }
            });
        };
    </script>
</body>
</html>
